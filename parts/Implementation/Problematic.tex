\subsection{Общая схема компиляции и возможные проблемы}
\label{impl:problem}

В главе FIXME было дано подробное описание особенностей работы процессоров Ascend.
Для написания эффективного компилятора необходимо учесть их и отразить
в создаваемой инфраструктуре. Кратко обозначим эти проблемы и пути их решения:

\begin{enumerate}
    \item \textit{Гетерогенность системы}. Работа с Ascend является примером
          гетерогенных вычилений. Поэтому компилятор должен генерировать
          отдельно код выполнения для хоста, и отдельно для девайса. Первый
          должен поддержить граф вычислений, аллоцировать память, планировать
          исполнение различных функций девайса. Далее в данной работе будет
          рассматриваться только компиляция и оптимизация кода девайса.
    
    \item \textit{Типы данных}. Зачастую входные данные имеют тип \texttt{float 32},
          но матричные вычисления на Ascend возможны только с типами
          \texttt{float 16} или \texttt{int 8}. По этой причине данные
          конвертируются в тип для вычислений. После выполнения операции,
          вероятно, необходима обратная конвертация.

    \item \textit{Форматы данных}. Напомним, матрицы для умножения должны иметь
          блочный формат хранения (\texttt{Zz}, \texttt{Zn} или \texttt{Nz}).
          Входные данные, как правило, не соответствуют ему, поэтому перед
          умножением необходимо выполнять операцию \textit{фрактализации}, т.~е.
          изменения формата хранения. Аналогично предыдущему пункту, после
          вычислений используется \textit{дефрактализация}.

    \item \textit{Использование памяти}. Размеры внутренних буферов ограничены,
          по этой причине для исполнения одной операции, зачастую, делается
          несколько загрузок из внешней памяти, которые могут повторяться в
          силу свойств операции (например, в случае блочного умножения матриц).
          Количество загрузок, особенно повторных, должно быть минимальным,
          т.~е. должна быть обеспечена пространственная и временная локальность.

    \item \textit{Параллелизм и синхронизация}. Как было отмечено, у процессоров
          с архитектурой DaVinci есть шесть юнитов, которые могут работать
          параллельно. По этой причине процент задействования каждого юнита
          (т.~е. время работы юнита по отношению к общему времени работы)
          должно быть максимизировано, для этого синхронизация между операциями
          различных юнитов должна присутствовать только в случае наличия
          зависимости по данным или именам, а само количество зависимостей ---
          минимизировано.

    \item \textit{Стратегии и расписание выполнения}. Стоит отметить, что в силу
          ограниченности памяти большинство операций будут представлены в виде
          цикла: загрузка-обработка-выгрузка. Очевидно, что загрузка может быть
          для разных по форме и размеру данных, а цикл может иметь различный
          порядок обхода. Таким образом, необходим выбор оптимальной стратегии
          (формы данных) и расписания (порядка обхода). Этот пункт включает
          в себя предыдущие два, но является более общим.
\end{enumerate}

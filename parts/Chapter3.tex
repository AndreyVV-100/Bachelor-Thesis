\section{Умножение матриц и свёртка с точки зрения процессора и компилятора}
\label{sec:Chapter3} \index{Chapter3}

\subsection{Умножение матриц}

Как было упомянуто ранее, нейропроцессоры в своей системе команд имеют
операцию умножения матриц. Но, в силу особенностей разработки и
применения процессоров, они имеют некоторые ограничения.

Во-первых, данные для умножения берутся из локального кэша, размер
которого сильно ограничен (характерный размер --- 64 КБ). Это означает,
что в подавляющем количестве случаев необходимо производить перемножение
по кусочкам. Удобный математический аппарат для этого --- блочное
перемножение матриц. Сама же техника называется \textit{tiling} или \textit{slicing}.

Во-вторых, сам процессор для удобства может требовать блочное расположение
матриц. Например, в целевой архитектуре вся матрица должна быть разбита
на блоки $16 \times 16$. Расположение элементов внутри блоков и блоков
относительно друг друга может быть также различно. Существуют две стратегии
размещения: про строкам (формат \texttt{Z}) и по столбцам (формат \texttt{N}).
Примем обозначение: размещение внутри блока обозначается строчной буквой, а
между блоками --- заглавной. Отметим, что в целевой архитектуре при умножении
$C = A \times B$ матрица $A$ должна быть заранее быть записана в формате \texttt{Zz},
матрица $B$ --- в формате \texttt{Zn}, а выходная матрица будет \texttt{Nz}.

В-третьих, в целях экономии целевой процессор поддерживает только умножение
матриц у коротких типов. Для чисел с плавающей точкой это \texttt{float 16},
для целочисленных вычислений --- \texttt{int 8}.

В связи с перечисленными выше причинами процедура перевода исходной
крупноблочной операции в команды процессора (будем называть эту процедуру
\textit{lowering-ом}) нетривиальной. Можно выделить несколько стадий lowering-а:

\begin{enumerate}
    \item Перевод исходных данных в сооответствующий блочный формат.
    \item Копирование данных из оперативной памяти в локальный кэш.
    \item Умножение матриц.
    \item Повторение п. 2-3 необходимое количество раз.
    \item Изменение формата хранения выходных данных (при необходимости).
\end{enumerate}

Отметим, что п. 1 и 5 выходят за рамки исследования данной работы.
Но, зачастую, они необходимы только на первом и последнем слоях нейронной сети,
так как промежуточные данные используются только самим процессором.

\subsection{Свёртка}

Реализация свёртки на нейроматрицных процессоров несколько сложнее, чем умножения.
На некоторых архитектурах (FIXME: ссылка) она поддержана нативно. К сожалению, наша
не является таковой. Но с помощью особого преобразования её можно свести к 
умножению матриц. Приведём некоторые общие соображения, которые позволят понять его.

Итак, пусть есть входное изображение (\textit{image}) размеров $H_i \times W_i$,
содержащее $C$ цветов. Будем называть его \textit{входной картой признаков}
(\textit{input feature map}). Ядро (\textit{kernel}) свёртки представляет из
себя небольшую матрицу размеров $H_k \times W_k$ (характерный размер --- $3-5$).
Ядро имеет такое же количество входных цветов $C$, но также имеет и $F$
выходных цветов. Таким образом, изображение имеет формат $H_i W_i C$,
а ядро --- $F H_k W_k C$. Выходная карта признаков, имеет структуру, схожую
со входной: $H_o W_o F$, где $H_o = H_i - H_k + 1$, $W_o = W_i - W_k + 1$
в простейшем случае. Если обозначить: $a$ --- входная карта, $k$ --- ядро,
$c$ --- выходная, то свёрка выражается следующей формулой:

\[
    c_{ijf} = \sum \limits_{h = 0}^{H_k} \sum \limits_{w = 0}^{W_k}
              \sum \limits_{c = 0}^{C} a_{i+h, j+w, c} \cdot k_{f h w c}
\]

Заметим, что операция чем-то схожа на скалярное умножение векторов
(если цвета считать вектором) или матричное умножение. Если первый тензор
преобразовать в матрицу $A$, где одной строке будет соответвовать одна
такая сумма (т.е. размеры матрицы станут $H_o W_o \times H_k W_k C$), а
ядро --- в матрицу $K$ размеров $H_k W_k C \times F$, то выходная
матрица $C = A \times K$. Этот процесс преобразования входной карты
признаков называется \textit{img2col} (\textit{image-to-column}),
оно содержится в архитектуре команд целевого процессора.

Таким образом, свёрка есть композиция \textit{img2col} и умножения матриц.
Отметим, что в реальности свёртка имеет такие параметры, как
\textit{stride}, \textit{dilation} и \textit{pad}. Они усложняют
приведённые формулы, но не меняют сути происходящего. Также в
качестве обобщения можно взять $N$ изображений, форматы входной и
выходной карт приобретают вид $N H_i W_i C$ и $N H_o W_o F$ соответственно.

\newpage
